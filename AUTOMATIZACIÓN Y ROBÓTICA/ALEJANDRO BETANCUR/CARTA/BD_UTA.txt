	-----TABLAS-----

CREATE TABLE ROLES(
IdRol int AUTO_INCREMENT Primary Key,
NomRol varchar(15) not null
)ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE utf8_unicode_ci;

CREATE TABLE PERMISOS(
IdPer int AUTO_INCREMENT Primary key,
nomPer varchar(15) not null
)ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE utf8_unicode_ci;

CREATE TABLE CARRERAS(
IdCar int AUTO_INCREMENT Primary Key,
NomCar varchar(50) not null
)ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE utf8_unicode_ci;

CREATE TABLE PLANTILLAS_DIRECTORIOS(
IdPlan int AUTO_INCREMENT primary key,
NomPlan varchar(150) not null
)ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE utf8_unicode_ci;

CREATE TABLE ITEMS_SUBDIRECTORIOS(
IdItem int AUTO_INCREMENT primary key,
NomItem varchar(150) not null
)ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE utf8_unicode_ci;

CREATE TABLE ITEMS_PLANTILLAS(
IdItem int AUTO_INCREMENT primary key,
NomItem varchar(150) not null
)ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE utf8_unicode_ci;

CREATE TABLE USUARIOS(
IdUser int AUTO_INCREMENT Primary Key,
NomUser varchar(60) not null,
ApeUser varchar(60) not null,
Correo varchar(100) not null,
Contraseña varchar(120) not null,
IdRolPer int not null,
FOREIGN key (IdRolPer) REFERENCES ROLES(IdRol) 
)ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE utf8_unicode_ci;

CREATE TABLE CARRERAS_SECRETARIAS(
CarSecId int AUTO_INCREMENT Primary Key,
IdCarPer int not null,
IdUserPer int not null,
FOREIGN key (IdCarPer) REFERENCES CARRERAS(IdCar),
FOREIGN key (IdUserPer) REFERENCES USUARIOS(IdUser)
)ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE utf8_unicode_ci;

CREATE TABLE USUARIOS_PERMISOS(
IdRelacion int AUTO_INCREMENT Primary key,
IdUserPer int not null,
IdPerPer int not null,
IdItemSubPer int not null,
FOREIGN key (IdUserPer) REFERENCES USUARIOS(idUser),
FOREIGN key (IdPerPer) REFERENCES PERMISOS(idPer),
FOREIGN key (IdItemSubPer) REFERENCES ITEMS_SUBDIRECTORIOS(IdItem)
)ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE utf8_unicode_ci;

CREATE TABLE ESTUDIANTES(
IdEst int AUTO_INCREMENT primary key,
NomEst varchar(20) not null,
ApeEst varchar(20) not null,
CedEst varchar(10) not null,
Fecha DATE DEFAULT CURDATE(),
Nom_Modificador varchar(60) not null,
IdCarPer int not null,
IdPlanPer int not null,
FOREIGN key (IdCarPer) REFERENCES CARRERAS(IdCar),
FOREIGN key (IdPlanPer) REFERENCES PLANTILLAS_DIRECTORIOS(IdPlan)
)ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE utf8_unicode_ci;

CREATE TABLE ARCHIVOS_ESTUDIANTES(
IdArch int AUTO_INCREMENT primary key,
RutaArch varchar(30) not null,
Observacion varchar(200) not null,
IdEstPer int not null,
FOREIGN key (IdEstPer) REFERENCES ESTUDIANTES(IdEst)
)ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE utf8_unicode_ci;

CREATE TABLE ITEMS_DIRECTORIOS(
IdItemDir int AUTO_INCREMENT primary key,
IdPlanPer int not null,
IdSubDirPer int not null,
FOREIGN key (IdPlanPer ) REFERENCES PLANTILLAS_DIRECTORIOS(IdPlan),
FOREIGN key (IdSubDirPer) REFERENCES ITEMS_PLANTILLAS(IdItem)
)ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE utf8_unicode_ci;


-- Reiniciar AUTO_INCREMENT para cada tabla
ALTER TABLE ROLES AUTO_INCREMENT = 1;
ALTER TABLE PERMISOS AUTO_INCREMENT = 1;
ALTER TABLE CARRERAS AUTO_INCREMENT = 1;
ALTER TABLE USUARIOS AUTO_INCREMENT = 1;
ALTER TABLE CARRERAS_SECRETARIAS AUTO_INCREMENT = 1;
ALTER TABLE USUARIOS_PERMISOS AUTO_INCREMENT = 1;
ALTER TABLE ESTUDIANTES AUTO_INCREMENT = 1;
ALTER TABLE ARCHIVOS_ESTUDIANTES AUTO_INCREMENT = 1;
ALTER TABLE PLANTILLAS_DIRECTORIOS AUTO_INCREMENT = 1;
ALTER TABLE ITEMS_SUBDIRECTORIOS AUTO_INCREMENT = 1;
ALTER TABLE ITEMS_DIRECTORIOS AUTO_INCREMENT = 1;




	----INSERTS----

INSERT INTO ROLES (NomRol) VALUES
('Administrador'),
('Secretari@');

INSERT INTO PERMISOS (nomPer) VALUES
('Lectura'),
('Eliminar'),
('Editar'),
('Crear');

INSERT INTO CARRERAS (NomCar) VALUES
('Ingeniería Industrial'),
('Software'),
('TI'),
('Telecomunicaciones'),
('Automatización y robótica');


INSERT INTO USUARIOS (NomUser, ApeUser, Correo ,Contraseña, IdRolPer) VALUES
('Juan', 'Pérez','jPerez243@uta.ed.ec', 'clave123', 1),
('María', 'González','mGonzales456@gmail.com', 'mypass', 2),
('Pedro', 'Sánchez','Psanchez123', 'password', 2);

INSERT INTO CARRERAS_SECRETARIAS (IdCarPer, IdUserPer) VALUES
(1, 2),
(3, 3),
(5, 1),
(2, 2),
(4, 3);

INSERT INTO PLANTILLAS_DIRECTORIOS (NomPlan) VALUES
('Estudiantes Nuevos'),
('Estudiantes Antiguos');


-- Insert data into ITEMS_SUBDIRECTORIOS table
INSERT INTO ITEMS_SUBDIRECTORIOS (NomItem) VALUES
('Cedula'),
('Practicas'),
('Ingles'),
('Educacion Fisica');

INSERT INTO ITEMS_PLANTILLAS (NomItem) VALUES
('Cedula'),
('Practicas'),
('Ingles'),
('Educacion Fisica');

INSERT INTO Usuarios_Permisos (IdUserPer, IdPerPer, IdItemSubPer) VALUES
(1, 1, 1),
(1, 2, 1),
(1, 3, 1),
(1, 4, 1),
(1, 2, 2),
(1, 3, 2),
(1, 4, 2),
(2, 2, 1),
(3, 3, 1),
(2, 4, 1);


INSERT INTO ESTUDIANTES (NomEst, ApeEst, CedEst, Fecha, Nom_Modificador, IdCarPer, IdPlanPer) VALUES
('Ana', 'López', '1801', '2023/01/12','Paulo Martinez',1,2),
('Carlos', 'Ramírez', '1802', '2023/01/12','Paulo Martinez', 2,2),
('Laura', 'García', '1803', '2023/01/12','Paulo Martinez', 3,2),
('Miguel', 'Fernández', '1804', '2023/01/12','Paulo Martinez', 4,2),
('Sofía', 'Rodríguez', '1805', '2023/01/12','Paulo Martinez', 5,1);


INSERT INTO ARCHIVOS_ESTUDIANTES (RutaArch, Onservacion, IdEstPer)  VALUES
('/archivos/estudiante1.pdf', 'Observaciones sobre el estudiante 1', 1),
('/archivos/estudiante2.doc', 'Informe del estudiante 2', 2),
('/archivos/estudiante3.txt', 'Notas del estudiante 3', 3);


-- Insert data into ITEMS_DIRECTORIOS table
INSERT INTO ITEMS_DIRECTORIOS (IdPlanPer, IdSubDirPer) VALUES
(1, 1),
(1, 2),
(1, 3),
(1, 4),
(2, 1),
(2, 2),
(2, 3);



	----CONSULTAS----
//USUARIOS
SELECT
    u.NomUser,
    u.ApeUser,
    u.Correo,
    GROUP_CONCAT(DISTINCT c.NomCar) AS Carreras,
    r.NomRol,
    GROUP_CONCAT(DISTINCT p.nomPer) AS Permisos
FROM
    usuarios AS u
JOIN carreras_secretarias AS cs ON u.idUser = cs.idUserPer
JOIN carreras AS c ON cs.idCarPer = c.IdCar
JOIN roles AS r ON u.IdRolPer = r.IdRol
LEFT JOIN usuarios_permisos AS up ON u.idUser = up.idUserPer
LEFT JOIN permisos AS p ON up.idPerPer = p.idPer
GROUP BY
    u.NomUser;

//CARRERAS
SELECT IdCar, NomCar FROM carreras

//ESTUDIANTES
SELECT NomEst, ApeEst, Fecha, NomCar
FROM estudiantes as e JOIN carreras as c ON e.IdCarPer = c.IdCar
ORDER BY
    e.NomEst;


//ESTUDIANTES
SELECT e.IdEst, e.NomEst, e.ApeEst, e.CedEst, e.Fecha, c.IdCar, c.NomCar, u.NomUser
FROM estudiantes as e
JOIN Carreras as c ON e.IdCarPer = c.IdCar
JOIN Carreras_Secretarias as cs ON c.IdCar = cs.IdCarPer
JOIN Usuarios as u ON cs.IdUserPer = u.IdUser
WHERE c.IdCar = 5
  AND u.IdUser = 1

//PERMISOS USUARIO Y CARPETAS
SELECT GROUP_CONCAT(DISTINCT u.IdUser) AS IdUser , GROUP_CONCAT(DISTINCT u.NomUser) AS NomUser, 
GROUP_CONCAT(DISTINCT isd.IdItem) as IdItem , GROUP_CONCAT(DISTINCT isd.NomItem) as NomItem, 
GROUP_CONCAT(DISTINCT p.IdPer) as IdPer , GROUP_CONCAT(DISTINCT p.NomPer) as NomPer
from usuarios_permisos as up JOIN usuarios as u ON up.IdUserPer = u.IdUser
JOIN permisos as p ON up.IdPerPer = p.IdPer
JOIN Items_SubDirectorios as isd ON up.IdItemSubPer = isd.IdItem
WHERE u.IdUser = 1
